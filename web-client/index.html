<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #fef3c7 100%);
            min-height: 100vh;
            padding: 60px 20px;
            color: #1e293b;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 60px;
        }

        .header h1 {
            font-size: 52px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #0f172a;
            letter-spacing: -1px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .header .subtitle {
            font-size: 18px;
            color: #64748b;
            font-weight: 400;
        }

        .section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 40px;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid rgba(255,255,255,0.8);
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 28px;
            color: #0f172a;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #475569;
        }

        input, select {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            outline: none;
            transition: all 0.2s;
            background: white;
        }

        input:focus, select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }

        button {
            padding: 14px 28px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.25s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-edit {
            background: #f1f5f9;
            color: #475569;
            padding: 10px 18px;
            font-size: 14px;
            margin-right: 6px;
        }

        .btn-edit:hover {
            background: #e2e8f0;
        }

        .btn-warning {
            background: #fbbf24;
            color: white;
            padding: 10px 18px;
            font-size: 14px;
        }

        .btn-warning:hover {
            background: #f59e0b;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            padding: 10px 18px;
            font-size: 14px;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 28px;
        }

        th {
            text-align: left;
            padding: 14px;
            background: #f8fafc;
            font-weight: 700;
            font-size: 13px;
            color: #64748b;
            border-bottom: 2px solid #e2e8f0;
        }

        td {
            padding: 16px 14px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 15px;
        }

        tr:hover {
            background: #fafafa;
        }

        .alert-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            color: white;
        }

        .color-preview {
            display: inline-block;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 2px solid #e2e8f0;
            vertical-align: middle;
        }

        /* BEAUTIFUL WEATHER CARD */
        .weather-card {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            padding: 56px 40px;
            border-radius: 16px;
            text-align: center;
            margin-top: 28px;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
            color: white;
        }

        .weather-city {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 16px;
            opacity: 0.95;
        }

        .weather-temp {
            font-size: 76px;
            font-weight: 200;
            margin-bottom: 12px;
            letter-spacing: -3px;
        }

        .weather-desc {
            font-size: 20px;
            margin-bottom: 24px;
            opacity: 0.95;
        }

        .weather-status {
            display: inline-block;
            padding: 10px 24px;
            background: rgba(255,255,255,0.25);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
        }

        /* ALERT MESSAGE BOX */
        .alert-message-box {
            margin-top: 28px;
            padding: 24px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 20px;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .alert-icon {
            font-size: 32px;
        }

        .alert-content {
            flex: 1;
            text-align: left;
        }

        .alert-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .alert-text {
            font-size: 16px;
            opacity: 0.95;
        }

        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 28px;
        }

        .report-item {
            background: #f8fafc;
            padding: 32px 24px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .report-item .label {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .report-item .value {
            font-size: 32px;
            font-weight: 700;
            color: #0f172a;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #94a3b8;
            font-size: 16px;
        }

        .toast {
            position: fixed;
            top: 24px;
            right: 24px;
            background: #0f172a;
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: none;
            animation: slideIn 0.3s ease;
            z-index: 1000;
            font-weight: 600;
        }

        .toast.error {
            background: #ef4444;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 28px;
            color: #3b82f6;
            font-weight: 600;
            font-size: 16px;
        }

        .hidden {
            display: none;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 540px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-title {
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 28px;
            color: #0f172a;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 28px;
            justify-content: flex-end;
        }

        .btn-cancel {
            background: #f1f5f9;
            color: #475569;
            padding: 14px 28px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }

        .btn-cancel:hover {
            background: #e2e8f0;
        }

        /* Compact Section */
        .compact-section {
            padding: 28px 40px;
        }

        .compact-section .section-title {
            font-size: 20px;
            margin-bottom: 16px;
        }

        .compact-section p {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 16px;
            line-height: 1.6;
        }
    </style>
</head>
<body>

<div class="toast" id="toast"></div>

<!-- Edit Modal -->
<div class="modal" id="editModal">
    <div class="modal-content">
        <div class="modal-title">Edit Alert Rule</div>
        <form id="editForm" onsubmit="saveEdit(event)">
            <input type="hidden" id="editId">
            <div class="form-row">
                <div class="form-group">
                    <label>Alert Type</label>
                    <select id="editAlertType" required>
                        <option value="TEMPERATURE">Temperature</option>
                        <option value="HUMIDITY">Humidity</option>
                        <option value="WIND">Wind Speed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Condition</label>
                    <div style="display: flex; gap: 8px;">
                        <select id="editOperator" required style="width: 80px;">
                            <option value=">">></option>
                            <option value="<"><</option>
                            <option value=">=">>=</option>
                            <option value="<="><=</option>
                        </select>
                        <input type="number" step="0.1" id="editThreshold" required style="flex: 1;">
                    </div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Severity</label>
                    <select id="editSeverity" required>
                        <option value="LOW">Low</option>
                        <option value="MEDIUM">Medium</option>
                        <option value="HIGH">High</option>
                        <option value="EXTREME">Extreme</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <input type="color" id="editColor" required>
                </div>
            </div>
            <div class="form-group">
                <label>Alert Message</label>
                <input type="text" id="editMessage" required>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeEditModal()">Cancel</button>
                <button type="submit" class="btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<div class="container">
    <div class="header">
        <h1>‚õÖ Weather System</h1>
        <p class="subtitle">Distributed Microservices Architecture</p>
    </div>

    <!-- Alert Rules Manager -->
    <div class="section">
        <div class="section-title">‚ö° Alert Rules Manager</div>
        <form id="alertForm" onsubmit="addAlert(event)">
            <div class="form-row">
                <div class="form-group">
                    <label>Alert Type</label>
                    <select id="alertType" required>
                        <option value="TEMPERATURE">Temperature</option>
                        <option value="HUMIDITY">Humidity</option>
                        <option value="WIND">Wind Speed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Condition</label>
                    <div style="display: flex; gap: 8px;">
                        <select id="operator" required style="width: 80px;">
                            <option value=">">></option>
                            <option value="<"><</option>
                            <option value=">=">>=</option>
                            <option value="<="><=</option>
                        </select>
                        <input type="number" step="0.1" id="threshold" required placeholder="30" style="flex: 1;">
                    </div>
                </div>
                <div class="form-group">
                    <label>Severity</label>
                    <select id="severity" required>
                        <option value="LOW">Low</option>
                        <option value="MEDIUM">Medium</option>
                        <option value="HIGH">High</option>
                        <option value="EXTREME">Extreme</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <input type="color" id="color" required value="#667eea">
                </div>
            </div>
            <div class="form-group">
                <label>Alert Message</label>
                <input type="text" id="message" required placeholder="Temperature alert!">
            </div>
            <button type="submit" class="btn-primary">Add Alert Rule</button>
        </form>

        <table id="alertsTable">
            <thead>
            <tr>
                <th>ID</th>
                <th>Type</th>
                <th>Condition</th>
                <th>Severity</th>
                <th>Color</th>
                <th>Message</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="alertsBody">
            <tr><td colspan="8" class="empty-state">Loading...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- Live Weather -->
    <div class="section">
        <div class="section-title">üå§Ô∏è Live Weather</div>
        <div class="form-group">
            <label>City Name</label>
            <input type="text" id="grpcCity" placeholder="Warsaw">
        </div>
        <button class="btn-success" onclick="getLiveWeather()">Get Weather</button>
        <div id="grpcLoading" class="loading hidden">Loading weather data...</div>
        <div id="grpcResult" class="hidden"></div>
    </div>

    <!-- ============================================ -->
    <!-- DODAJ Tƒò SEKCJƒò do index.html              -->
    <!-- PO sekcji "Live Weather"                   -->
    <!-- ============================================ -->

    <!-- gRPC Server Streaming -->
    <div class="section">
        <div class="section-title">üåä gRPC Server Streaming - Live Updates</div>
        <p style="color: #64748b; margin-bottom: 20px; font-size: 14px;">
            Real-time weather updates via gRPC server streaming ‚Ä¢ Multiple onNext() calls ‚Ä¢ Live data from OpenWeatherMap
        </p>

        <div class="form-row">
            <div class="form-group">
                <label>City Name</label>
                <input type="text" id="streamCity" placeholder="Warsaw" value="Warsaw">
            </div>
            <div class="form-group">
                <label>Number of Updates</label>
                <input type="number" id="streamUpdates" placeholder="10" value="10" min="1" max="20">
            </div>
            <div class="form-group">
                <label>Interval (seconds)</label>
                <input type="number" id="streamInterval" placeholder="5" value="5" min="2" max="10">
            </div>
        </div>

        <button class="btn-success" onclick="startWeatherStream()" id="streamButton">
            üöÄ Start Live Stream
        </button>

        <div id="streamStatus" style="margin-top: 20px; padding: 16px; border-radius: 8px; display: none;"></div>
        <div id="streamResult" class="hidden"></div>
    </div>

    <script>
        // ============================================
        // gRPC Streaming Function
        // ============================================

        let streamInProgress = false;
        let currentEventSource = null;

        async function startWeatherStream() {
            if (streamInProgress) {
                showToast('Stream already in progress!', 'error');
                return;
            }

            const city = document.getElementById('streamCity').value.trim();
            const updates = document.getElementById('streamUpdates').value;
            const interval = document.getElementById('streamInterval').value;

            if (!city) {
                showToast('Enter a city name', 'error');
                return;
            }

            const statusDiv = document.getElementById('streamStatus');
            const resultDiv = document.getElementById('streamResult');
            const button = document.getElementById('streamButton');

            // Disable button
            streamInProgress = true;
            button.disabled = true;
            button.style.opacity = '0.5';
            button.textContent = '‚è≥ Streaming...';

            // Show status
            statusDiv.style.display = 'block';
            statusDiv.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            statusDiv.style.color = 'white';
            statusDiv.innerHTML = `
        <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px;">
            üì° Live Weather Stream Started
        </div>
        <div style="font-size: 14px; opacity: 0.9;">
            City: ${city} | Updates: ${updates} | Interval: ${interval}s
        </div>
        <div style="margin-top: 12px; font-size: 13px;">
            ‚è≥ Fetching updates from OpenWeatherMap API in real-time...
        </div>
    `;

            // Create table with empty body
            resultDiv.innerHTML = `
        <table style="margin-top: 20px;">
            <thead>
                <tr>
                    <th>#</th>
                    <th>City</th>
                    <th>Temperature</th>
                    <th>Description</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody id="streamTableBody">
                <tr>
                    <td colspan="5" style="text-align: center; color: #64748b;">
                        ‚è≥ Waiting for first update...
                    </td>
                </tr>
            </tbody>
        </table>
    `;
            resultDiv.classList.remove('hidden');

            const startTime = Date.now();
            let updateCount = 0;

            // Use Server-Sent Events (SSE) for real-time streaming!
            const eventSource = new EventSource(
                `http://localhost:8085/api/weather/stream-sse/${city}?updates=${updates}&intervalSeconds=${interval}`
            );
            currentEventSource = eventSource;

            // Listen for weather updates
            eventSource.addEventListener('weather-update', (event) => {
                const update = JSON.parse(event.data);
                updateCount++;

                console.log('üì• Received update:', update);

                // Add row to table in real-time!
                addStreamUpdateRow(update);

                // Update status with current progress
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                statusDiv.innerHTML = `
            <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px;">
                üì° Streaming... (${updateCount}/${updates})
            </div>
            <div style="font-size: 14px; opacity: 0.9;">
                City: ${city} | Elapsed: ${elapsed}s
            </div>
            <div style="margin-top: 12px; font-size: 13px; animation: pulse 2s infinite;">
                üîÑ Receiving live updates...
            </div>
        `;
            });

            // Stream completed
            eventSource.addEventListener('error', (event) => {
                console.log('Stream ended or error occurred');
                eventSource.close();
                currentEventSource = null;

                const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);

                statusDiv.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                statusDiv.innerHTML = `
            <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px;">
                ‚úÖ Stream Completed Successfully!
            </div>
            <div style="font-size: 14px;">
                Received ${updateCount} updates in ${elapsed}s
            </div>
        `;

                showToast(`‚úÖ Stream completed! ${updateCount} updates received`);

                // Re-enable button
                streamInProgress = false;
                button.disabled = false;
                button.style.opacity = '1';
                button.textContent = 'üöÄ Start Live Stream';
            });
        }

        function addStreamUpdateRow(update) {
            const tbody = document.getElementById('streamTableBody');

            // Remove "waiting" message if it exists
            if (tbody.querySelector('td[colspan="5"]')) {
                tbody.innerHTML = '';
            }

            // Create new row (no animation - just appears)
            const row = document.createElement('tr');
            row.innerHTML = `
        <td style="font-weight: 700; color: #3b82f6;">#${update.updateNumber}</td>
        <td>${update.city}</td>
        <td style="font-weight: 700; color: #10b981;">${update.temperature.toFixed(1)}¬∞C</td>
        <td>${update.description}</td>
        <td style="color: #64748b; font-size: 13px;">${new Date(update.timestamp).toLocaleTimeString()}</td>
    `;

            // Add to table (newest at bottom)
            tbody.appendChild(row);

            // Scroll to bottom to show newest update
            row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function displayStreamUpdates(updates) {
            const tbody = document.getElementById('streamTableBody');

            if (!updates || updates.length === 0) {
                tbody.innerHTML = `
            <tr>
                <td colspan="5" class="empty-state">No updates received</td>
            </tr>
        `;
                return;
            }

            tbody.innerHTML = updates.map(update => `
        <tr>
            <td style="font-weight: 700; color: #3b82f6;">#${update.updateNumber}</td>
            <td>${update.city}</td>
            <td style="font-weight: 700; color: #10b981;">${update.temperature.toFixed(1)}¬∞C</td>
            <td>${update.description}</td>
            <td style="color: #64748b; font-size: 13px;">${update.timestamp}</td>
        </tr>
    `).join('');
        }
    </script>

    <!-- Async gRPC (Compact) -->
    <div class="section compact-section">
        <div class="section-title">üöÄ Async gRPC Demo</div>
        <p>Non-blocking call with StreamObserver. Server responds immediately.</p>
        <div class="form-group">
            <input type="text" id="asyncCity" placeholder="City name" style="margin-bottom: 12px;">
        </div>
        <button class="btn-primary" onclick="testAsyncGrpc()">Test Async</button>
        <div id="asyncLoading" class="loading hidden">Calling...</div>
        <div id="asyncResult" class="hidden"></div>
    </div>

    <!-- SOAP Report -->
    <div class="section">
        <div class="section-title">üìä Weather Report (SOAP)</div>
        <div class="form-group">
            <label>City Name</label>
            <input type="text" id="soapCity" placeholder="Warsaw">
        </div>
        <button class="btn-success" onclick="generateReport()">Generate Report</button>
        <div id="soapLoading" class="loading hidden">Generating report...</div>
        <div id="soapResult" class="hidden"></div>
    </div>

    <!-- Historical Data -->
    <div class="section">
        <div class="section-title">üìÖ Historical Data (XML-RPC)</div>
        <div class="form-group">
            <label>City Name</label>
            <input type="text" id="xmlrpcCity" placeholder="Warsaw">
        </div>
        <button class="btn-success" onclick="getHistoricalWeather()">Get History</button>
        <div id="xmlrpcLoading" class="loading hidden">Loading history...</div>
        <div id="xmlrpcResult" class="hidden"></div>
    </div>
</div>

<script>
    const ALERTS_API = 'http://localhost:8084/api/alert-rules';
    const GRPC_API = 'http://localhost:8085/api/weather';
    const SOAP_API = 'http://localhost:8085/api/report';
    const XMLRPC_API = 'http://localhost:8088/xmlrpc/historical';

    let triggeredAlert = null; // Store alert info globally
    let alertsWithLinks = {}; // Store HATEOAS links for each alert

    window.onload = () => {
        loadAlerts();
    };

    // ALERTS CRUD
    async function loadAlerts() {
        try {
            const response = await fetch(`${ALERTS_API}?page=0&size=20&sortBy=createdAt`);
            const data = await response.json();

            // Store alerts with their HATEOAS links
            alertsWithLinks = {};
            data.content.forEach(alert => {
                // Handle both formats: _links (object) and links (array)
                if (alert._links) {
                    alertsWithLinks[alert.id] = alert._links;
                } else if (alert.links && Array.isArray(alert.links)) {
                    // Convert array format to object format
                    const linksObj = {};
                    alert.links.forEach(link => {
                        linksObj[link.rel] = { href: link.href };
                    });
                    alertsWithLinks[alert.id] = linksObj;
                }
            });

            console.log('üîó HATEOAS links loaded:', alertsWithLinks);
            displayAlerts(data.content);
        } catch (error) {
            showToast('Failed to load alerts', 'error');
        }
    }

    function displayAlerts(alerts) {
        const tbody = document.getElementById('alertsBody');
        if (alerts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No alerts yet</td></tr>';
            return;
        }
        tbody.innerHTML = alerts.map(alert => `
            <tr id="row-${alert.id}">
                <td>${alert.id}</td>
                <td>${alert.alertType}</td>
                <td>${alert.operator} ${alert.threshold}</td>
                <td><span class="alert-badge" style="background:${getSeverityColor(alert.severity)}">${alert.severity}</span></td>
                <td><span class="color-preview" style="background:${alert.color}"></span></td>
                <td>${alert.message}</td>
                <td style="color:${alert.active ? '#48bb78' : '#a0aec0'};font-weight:600">${alert.active ? 'Active' : 'Inactive'}</td>
                <td>
                    <button class="btn-edit" onclick="editAlert(${alert.id})">Edit</button>
                    <button class="btn-warning" onclick="toggleAlert(${alert.id})">${alert.active ? 'Disable' : 'Enable'}</button>
                    <button class="btn-danger" onclick="deleteAlert(${alert.id})">Delete</button>
                </td>
            </tr>
        `).join('');
    }

    function getSeverityColor(severity) {
        const colors = {'LOW': '#48bb78', 'MEDIUM': '#ed8936', 'HIGH': '#f56565', 'EXTREME': '#9b2c2c'};
        return colors[severity] || '#718096';
    }

    async function addAlert(event) {
        event.preventDefault();
        const data = {
            alertType: document.getElementById('alertType').value,
            threshold: parseFloat(document.getElementById('threshold').value),
            operator: document.getElementById('operator').value,
            severity: document.getElementById('severity').value,
            color: document.getElementById('color').value,
            message: document.getElementById('message').value,
            active: true
        };
        try {
            const response = await fetch(ALERTS_API, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if (response.ok) {
                showToast('Alert added!');
                document.getElementById('alertForm').reset();
                loadAlerts();
            } else {
                showToast('Failed to add alert', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    function editAlert(id) {
        const row = document.getElementById(`row-${id}`);
        const cells = row.cells;
        document.getElementById('editId').value = id;
        document.getElementById('editAlertType').value = cells[1].textContent;
        const condition = cells[2].textContent.trim().split(' ');
        document.getElementById('editOperator').value = condition[0];
        document.getElementById('editThreshold').value = parseFloat(condition[1]);
        document.getElementById('editSeverity').value = cells[3].textContent.trim();
        document.getElementById('editColor').value = cells[4].querySelector('.color-preview').style.background;
        document.getElementById('editMessage').value = cells[5].textContent;
        document.getElementById('editModal').classList.add('show');
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.remove('show');
    }

    async function saveEdit(event) {
        event.preventDefault();
        const id = document.getElementById('editId').value;
        const data = {
            alertType: document.getElementById('editAlertType').value,
            threshold: parseFloat(document.getElementById('editThreshold').value),
            operator: document.getElementById('editOperator').value,
            severity: document.getElementById('editSeverity').value,
            color: document.getElementById('editColor').value,
            message: document.getElementById('editMessage').value,
            active: true
        };
        try {
            // Use HATEOAS link if available, otherwise fallback to manual URL
            const updateUrl = alertsWithLinks[id]?.update?.href || `${ALERTS_API}/${id}`;

            const response = await fetch(updateUrl, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if (response.ok) {
                showToast('‚úÖ Alert updated using HATEOAS!');
                closeEditModal();
                loadAlerts();
            } else {
                showToast('Failed to update', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    async function toggleAlert(id) {
        try {
            // Use HATEOAS link if available, otherwise fallback to manual URL
            const toggleUrl = alertsWithLinks[id]?.toggle?.href || `${ALERTS_API}/${id}/toggle`;

            const response = await fetch(toggleUrl, {method: 'PATCH'});
            if (response.ok) {
                showToast('‚úÖ Status toggled using HATEOAS!');
                loadAlerts();
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    async function deleteAlert(id) {
        if (!confirm('Delete this alert?')) return;
        try {
            // Use HATEOAS link if available, otherwise fallback to manual URL
            const deleteUrl = alertsWithLinks[id]?.delete?.href || `${ALERTS_API}/${id}`;

            const response = await fetch(deleteUrl, {method: 'DELETE'});
            if (response.ok) {
                showToast('‚úÖ Alert deleted using HATEOAS!');
                loadAlerts();
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    // LIVE WEATHER with ALERT MESSAGE
    async function getLiveWeather() {
        const city = document.getElementById('grpcCity').value.trim();
        if (!city) {
            showToast('Enter a city name', 'error');
            return;
        }

        const loading = document.getElementById('grpcLoading');
        const result = document.getElementById('grpcResult');
        loading.classList.remove('hidden');
        result.classList.add('hidden');

        try {
            // Get weather
            const response = await fetch(`${GRPC_API}/${city}`);
            const data = await response.json();

            // Get active alerts to find triggered one
            const alertsResponse = await fetch(`${ALERTS_API}?page=0&size=100`);
            const alertsData = await alertsResponse.json();

            // Find matching alert
            triggeredAlert = null;
            if (data.status === 'ALERT') {
                const activeAlerts = alertsData.content.filter(a => a.active && a.alertType === 'TEMPERATURE');
                for (let alert of activeAlerts) {
                    if (eval(`${data.temperature} ${alert.operator} ${alert.threshold}`)) {
                        triggeredAlert = alert;
                        break;
                    }
                }
            }

            result.innerHTML = `
                <div class="weather-card">
                    <div class="weather-card-content">
                        <div class="weather-city">${data.city}</div>
                        <div class="weather-temp">${data.temperature.toFixed(1)}¬∞</div>
                        <div class="weather-desc">${data.description}</div>
                        <div class="weather-status">${data.status}</div>
                        ${triggeredAlert ? `
                            <div class="alert-message-box" style="border-left: 4px solid ${triggeredAlert.color}">
                                <div class="alert-icon">‚ö†Ô∏è</div>
                                <div class="alert-content">
                                    <div class="alert-title">${triggeredAlert.severity} Alert</div>
                                    <div class="alert-text">${triggeredAlert.message}</div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            result.classList.remove('hidden');
        } catch (error) {
            showToast('Failed to get weather', 'error');
        } finally {
            loading.classList.add('hidden');
        }
    }

    // ASYNC gRPC (Compact)
    async function testAsyncGrpc() {
        const city = document.getElementById('asyncCity').value.trim();
        if (!city) {
            showToast('Enter a city', 'error');
            return;
        }
        const loading = document.getElementById('asyncLoading');
        const result = document.getElementById('asyncResult');
        loading.classList.remove('hidden');
        result.classList.add('hidden');
        try {
            const response = await fetch(`http://localhost:8085/api/weather/async/${city}`);
            const data = await response.json();
            result.innerHTML = `
                <div style="margin-top:16px;padding:16px;background:#f7fafc;border-radius:8px;text-align:center">
                    <div style="font-weight:600;margin-bottom:8px">‚úÖ Response: ${data.responseTime}</div>
                    <div style="font-size:13px;color:#718096">${data.info}</div>
                </div>
            `;
            result.classList.remove('hidden');
        } catch (error) {
            showToast('Async failed', 'error');
        } finally {
            loading.classList.add('hidden');
        }
    }

    // SOAP REPORT
    async function generateReport() {
        const city = document.getElementById('soapCity').value.trim();
        if (!city) {
            showToast('Enter a city', 'error');
            return;
        }
        const loading = document.getElementById('soapLoading');
        const result = document.getElementById('soapResult');
        loading.classList.remove('hidden');
        result.classList.add('hidden');
        try {
            const response = await fetch(`${SOAP_API}/${city}?days=7`);
            const data = await response.json();
            result.innerHTML = `
                <div class="report-grid">
                    <div class="report-item"><div class="label">City</div><div class="value">${data.city}</div></div>
                    <div class="report-item"><div class="label">Avg Temp</div><div class="value">${data.avgTemp}¬∞C</div></div>
                    <div class="report-item"><div class="label">Min Temp</div><div class="value">${data.minTemp}¬∞C</div></div>
                    <div class="report-item"><div class="label">Max Temp</div><div class="value">${data.maxTemp}¬∞C</div></div>
                </div>
                <div style="margin-top:20px;padding:20px;background:#f7fafc;border-radius:12px;font-size:14px;line-height:1.6">
                    ${data.summary}
                </div>
            `;
            result.classList.remove('hidden');
        } catch (error) {
            showToast('Failed to generate report', 'error');
        } finally {
            loading.classList.add('hidden');
        }
    }

    // HISTORICAL
    async function getHistoricalWeather() {
        const city = document.getElementById('xmlrpcCity').value.trim();
        if (!city) {
            showToast('Enter a city', 'error');
            return;
        }
        const loading = document.getElementById('xmlrpcLoading');
        const result = document.getElementById('xmlrpcResult');
        loading.classList.remove('hidden');
        result.classList.add('hidden');
        try {
            const response = await fetch(`${XMLRPC_API}?city=${city}&days=5`);
            const data = await response.json();
            if (Array.isArray(data) && data.length > 0) {
                result.innerHTML = `
                    <table>
                        <thead><tr><th>Date/Time</th><th>Temp</th><th>Description</th><th>Humidity</th></tr></thead>
                        <tbody>
                            ${data.map(day => `
                                <tr>
                                    <td>${day.timestamp ? new Date(day.timestamp).toLocaleString('pl-PL') : 'N/A'}</td>
                                    <td>${day.temperature ? day.temperature.toFixed(1) : 'N/A'}¬∞C</td>
                                    <td>${day.description || 'N/A'}</td>
                                    <td>${day.humidity || 'N/A'}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                result.innerHTML = '<div class="empty-state">No data. Check weather first!</div>';
            }
            result.classList.remove('hidden');
        } catch (error) {
            showToast('Failed to get history', 'error');
        } finally {
            loading.classList.add('hidden');
        }
    }

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast ${type}`;
        toast.style.display = 'block';
        setTimeout(() => toast.style.display = 'none', 3000);
    }
</script>

<!-- ============================================ -->
<!-- NOWA SEKCJA XML-RPC                         -->
<!-- Zamie≈Ñ ca≈ÇƒÖ sekcjƒô "Historical Data" na tƒô!-->
<!-- ============================================ -->

<!-- XML-RPC Historical Data -->
<div class="section">
    <div class="section-title">üìã XML-RPC Historical Data</div>
    <p style="color: #64748b; margin-bottom: 20px; font-size: 14px;">
        Apache XML-RPC protocol ‚Ä¢ Synchronous + Asynchronous (3-second delay) ‚Ä¢ Connected to real database
    </p>

    <div class="form-row">
        <div class="form-group">
            <label>City Name</label>
            <input type="text" id="xmlrpcCityNew" placeholder="Warsaw" value="Warsaw">
        </div>
        <div class="form-group">
            <label>Number of Days</label>
            <input type="number" id="xmlrpcDaysNew" placeholder="5" value="5" min="1" max="10">
        </div>
    </div>

    <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 20px;">
        <button class="btn-primary" onclick="getXmlRpcHistoryNew()">
            ‚ö° Get History (Sync)
        </button>
        <button class="btn-success" onclick="getXmlRpcHistoryAsyncNew()">
            ‚è±Ô∏è Get History (Async 3s)
        </button>
        <button style="padding: 14px 28px; font-size: 16px; font-weight: 600; border: none; border-radius: 10px; cursor: pointer; background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white;"
                onclick="getXmlRpcStatisticsNew()">
            üìä Get Statistics
        </button>
    </div>

    <div id="xmlrpcStatusNew" class="loading hidden"></div>
    <div id="xmlrpcResultNew" class="hidden"></div>
</div>

<script>
    // ============================================
    // XML-RPC Functions - POPRAWIONE!
    // ============================================

    async function getXmlRpcHistoryNew() {
        const city = document.getElementById('xmlrpcCityNew').value.trim();
        const days = document.getElementById('xmlrpcDaysNew').value;

        if (!city) {
            showToast('Enter a city name', 'error');
            return;
        }

        const statusDiv = document.getElementById('xmlrpcStatusNew');
        const resultDiv = document.getElementById('xmlrpcResultNew');

        statusDiv.textContent = '‚è≥ Calling XML-RPC Server (synchronous)...';
        statusDiv.classList.remove('hidden');
        resultDiv.classList.add('hidden');

        try {
            const response = await fetch(`http://localhost:8085/api/xmlrpc-proxy/history/${city}?days=${days}`);
            const data = await response.json();

            statusDiv.classList.add('hidden');
            displayXmlRpcHistoryNew(data, false);
            showToast('‚úÖ XML-RPC sync call completed!');

        } catch (error) {
            statusDiv.classList.add('hidden');
            showToast('Failed to call XML-RPC: ' + error.message, 'error');
        }
    }

    async function getXmlRpcHistoryAsyncNew() {
        const city = document.getElementById('xmlrpcCityNew').value.trim();
        const days = document.getElementById('xmlrpcDaysNew').value;

        if (!city) {
            showToast('Enter a city name', 'error');
            return;
        }

        const statusDiv = document.getElementById('xmlrpcStatusNew');
        const resultDiv = document.getElementById('xmlrpcResultNew');

        statusDiv.textContent = '‚è≥ Calling XML-RPC Server (async with 3-second delay)... Please wait...';
        statusDiv.classList.remove('hidden');
        resultDiv.classList.add('hidden');

        const startTime = Date.now();

        try {
            const response = await fetch(`http://localhost:8085/api/xmlrpc-proxy/history-async/${city}?days=${days}`);
            const data = await response.json();

            const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);

            statusDiv.classList.add('hidden');
            displayXmlRpcHistoryNew(data, true, elapsed);
            showToast(`‚úÖ XML-RPC async completed! (${elapsed}s with 3s server delay)`);

        } catch (error) {
            statusDiv.classList.add('hidden');
            showToast('Failed to call XML-RPC: ' + error.message, 'error');
        }
    }

    async function getXmlRpcStatisticsNew() {
        const city = document.getElementById('xmlrpcCityNew').value.trim();

        if (!city) {
            showToast('Enter a city name', 'error');
            return;
        }

        const statusDiv = document.getElementById('xmlrpcStatusNew');
        const resultDiv = document.getElementById('xmlrpcResultNew');

        statusDiv.textContent = '‚è≥ Getting statistics via XML-RPC...';
        statusDiv.classList.remove('hidden');
        resultDiv.classList.add('hidden');

        try {
            const response = await fetch(`http://localhost:8085/api/xmlrpc-proxy/statistics/${city}`);
            const data = await response.json();

            statusDiv.classList.add('hidden');
            displayXmlRpcStatisticsNew(data);
            showToast('‚úÖ Statistics retrieved via XML-RPC!');

        } catch (error) {
            statusDiv.classList.add('hidden');
            showToast('Failed to get statistics: ' + error.message, 'error');
        }
    }

    function displayXmlRpcHistoryNew(data, isAsync, elapsed) {
        const resultDiv = document.getElementById('xmlrpcResultNew');

        if (!Array.isArray(data) || data.length === 0) {
            resultDiv.innerHTML = '<div class="empty-state">No historical data available. Check weather first!</div>';
            resultDiv.classList.remove('hidden');
            return;
        }

        // Check if first record has error
        if (data[0].error) {
            resultDiv.innerHTML = `
                <div style="padding: 20px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 12px; color: white; text-align: center;">
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">
                        ‚ö†Ô∏è No Historical Data
                    </div>
                    <div style="font-size: 14px;">
                        ${data[0].error}
                    </div>
                    <div style="margin-top: 12px; font-size: 13px; opacity: 0.9;">
                        üí° Tip: First get current weather for ${data[0].city} to generate history!
                    </div>
                </div>
            `;
            resultDiv.classList.remove('hidden');
            return;
        }

        let html = `
        <div style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white; margin-bottom: 20px;">
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">
                ${isAsync ? '‚è±Ô∏è Asynchronous Call' : '‚ö° Synchronous Call'}
            </div>
            <div style="font-size: 14px; opacity: 0.9;">
                Retrieved ${data.length} records from Weather Provider via XML-RPC protocol
                ${isAsync ? ` ‚Ä¢ Completed in ${elapsed}s (includes 3s server delay)` : ''}
            </div>
        </div>
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>City</th>
                    <th>Temperature</th>
                    <th>Description</th>
                    <th>Timestamp</th>
                </tr>
            </thead>
            <tbody>
    `;

        data.forEach((record, index) => {
            html += `
            <tr>
                <td>${index + 1}</td>
                <td>${record.city || 'Unknown'}</td>
                <td style="font-weight: 700; color: #3b82f6;">${record.temperature ? record.temperature.toFixed(1) : 'N/A'}¬∞C</td>
                <td>${record.description || 'N/A'}</td>
                <td style="color: #64748b; font-size: 14px;">${record.timestamp || record.date || 'N/A'}</td>
            </tr>
        `;
        });

        html += `
            </tbody>
        </table>
    `;

        resultDiv.innerHTML = html;
        resultDiv.classList.remove('hidden');
    }

    function displayXmlRpcStatisticsNew(data) {
        const resultDiv = document.getElementById('xmlrpcResultNew');

        if (data.error) {
            resultDiv.innerHTML = `<div class="empty-state">‚ö†Ô∏è ${data.error}</div>`;
            resultDiv.classList.remove('hidden');
            return;
        }

        resultDiv.innerHTML = `
        <div class="report-grid">
            <div class="report-item">
                <div class="label">City</div>
                <div class="value">${data.city || 'Unknown'}</div>
            </div>
            <div class="report-item">
                <div class="label">Average Temp</div>
                <div class="value">${data.avgTemp || data.averageTemperature || 'N/A'}¬∞C</div>
            </div>
            <div class="report-item">
                <div class="label">Min Temp</div>
                <div class="value">${data.minTemp || data.minTemperature || 'N/A'}¬∞C</div>
            </div>
            <div class="report-item">
                <div class="label">Max Temp</div>
                <div class="value">${data.maxTemp || data.maxTemperature || 'N/A'}¬∞C</div>
            </div>
            <div class="report-item">
                <div class="label">Records</div>
                <div class="value">${data.recordCount || data.count || 'N/A'}</div>
            </div>
        </div>
    `;

        resultDiv.classList.remove('hidden');
    }
</script>
</body>
</html>